(async function(){const e=i();if(!e&&!window.location.pathname.includes("/login")){t();return}try{if(!(await fetch("/api/auth/validar-token",{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},credentials:"include"})).ok&&(console.warn("Token inválido, intentando refrescar..."),!await l())){t();return}document.documentElement.style.visibility="visible"}catch(n){console.error("Error verificando token:",n),t()}})();function i(){return window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?localStorage.getItem("token"):s()}function a(o){window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?localStorage.setItem("token",o):document.cookie=`token=${o}; path=/; Secure; HttpOnly; SameSite=Lax`}function c(){window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?localStorage.removeItem("token"):document.cookie="token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=Lax"}function s(){const e=document.cookie.split("; ").find(n=>n.startsWith("token="));return e?e.split("=")[1]:null}async function l(){try{const o=await fetch("/api/auth/refresh",{method:"POST",headers:{Authorization:`Bearer ${i()}`,"Content-Type":"application/json"},credentials:"include"});if(!o.ok)return console.warn("No se pudo refrescar el token, cerrando sesión."),r(),null;const e=await o.json();return a(e.token),e.usuario}catch(o){return console.error("Error refrescando token:",o),r(),null}}function r(){const o=i();o&&(navigator.sendBeacon("/api/auth/logout",JSON.stringify({token:o})),c(),t())}function t(){window.location.pathname.includes("/login")||(window.location.href="/login")}
